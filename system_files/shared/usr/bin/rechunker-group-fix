#!/usr/bin/env bash

# See /usr/lib/systemd/system/rechunker-group-fix.service for more details
# https://github.com/zirconium-dev/zirconium/commit/85cc566697b3337d37e2b6c6305c51b7f1a9e9b1
# thanks @tullilirockz @hecknt

# To use this script, you'll want to put this in your systemd service:
# rm /etc/gshadow
# systemd-sysusers
# (run this script)
# systemd-tmpfiles --create --remove --boot --exclude-prefix=/dev
# This will populate /etc/group successfully, and then populate /etc/gshadow
# with any missing groups that we nuked when we removed /etc/gshadow

GSHADOW_FILE="/etc/gshadow"
GROUP_FILE="/etc/group"

for f in $(cat $GROUP_FILE); do
   cut -f1 -d':' <(echo $f) | xargs -I{} grep ^"{}" $GSHADOW_FILE &>/dev/null || \
     echo $(cut -f1 -d':' <(echo $f)):'!*::' >> $GSHADOW_FILE
done && \
cat > /etc/.aurora-rechunker-fix-do-not-remove <<EOF
This file is for the group fix for the legacy rechunker. Do not remove this file, otherwise your groups will be modified.
On Fedora Silverblue and many Universal Blue images, the groups are split into 2 files: /usr/lib/group, and /etc/group.
This is a bad implementation that breaks the ability to rebase to an image that doesn't have a /usr/lib/group file. [1]
This is functionality that is created by nss-altfiles[2], which is NOT standard, and modifies glibc to use /usr/lib/group.


[1]: https://github.com/ublue-os/main/issues/759
[2]: https://github.com/aperezdc/nss-altfiles
EOF
